<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAZE.IO // SYSTEM</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg: #ffffff;
            --fg: #000000;
            --accent: #2c2c2c;
            --grid-line: #e5e5e5;
            --p1: #0000ff; /* International Klein Blue */
            --p2: #ff0000; /* Bright Red */
        }

        * {
            box-sizing: border-box;
            border-radius: 0 !important; /* STRICT HARD CORNERS */
            outline: none;
            user-select: none;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3 { text-transform: uppercase; letter-spacing: -1px; margin: 0; }
        h1 { font-weight: 900; font-size: 4rem; line-height: 0.9; }
        p { font-weight: 300; line-height: 1.5; font-size: 0.9rem; color: #555; }
        
        /* --- BUTTONS --- */
        button {
            background: var(--fg);
            color: var(--bg);
            border: none;
            padding: 15px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            border: 1px solid var(--fg);
        }

        button:hover {
            background: var(--bg);
            color: var(--fg);
        }

        button.secondary {
            background: transparent;
            color: var(--fg);
            border: 1px solid #ccc;
        }

        input {
            border: 2px solid var(--fg);
            padding: 15px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 10px;
            transition: border 0.3s;
        }

        input:focus { border-color: var(--p1); }

        /* --- LOADING SCREEN --- */
        #loader-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: var(--bg);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .spiral-grid {
            display: grid;
            grid-template-columns: repeat(10, 20px);
            grid-template-rows: repeat(10, 20px);
            gap: 2px;
        }

        .block {
            width: 100%;
            height: 100%;
            background: var(--fg);
            opacity: 0;
            transform: scale(0);
        }

        @keyframes ripple {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        .animating {
            animation: ripple 1.8s infinite ease-in-out;
        }

        .loading-text {
            margin-top: 40px;
            font-size: 0.7rem;
            letter-spacing: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink { 50% { opacity: 0.3; } }

        /* --- MAIN UI LAYOUT --- */
        #app-container {
            display: none; /* Hidden until loaded */
            height: 100vh;
            display: grid;
            grid-template-columns: 350px 1fr;
        }

        /* SIDEBAR */
        aside {
            border-right: 1px solid #ddd;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: #fafafa;
        }

        .menu-items { display: flex; flex-direction: column; gap: 10px; margin-top: 40px; }

        #timer-display {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: 900;
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            background: #fff;
        }

        /* MAIN CANVAS AREA */
        main {
            position: relative;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(#e5e5e5 1px, transparent 1px);
            background-size: 20px 20px;
        }

        canvas {
            border: 2px solid var(--fg);
            box-shadow: 20px 20px 0px rgba(0,0,0,0.05);
        }

        /* --- POPUPS / MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal-content {
            background: #fff;
            border: 2px solid var(--fg);
            width: 500px;
            padding: 40px;
            box-shadow: 30px 30px 0px var(--fg);
            transform: translateY(50px);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .modal-overlay.active .modal-content { transform: translateY(0); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--fg);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .close-btn {
            background: var(--fg);
            color: var(--bg);
            border: none;
            font-size: 1.5rem;
            width: 40px; 
            height: 40px;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .close-btn:hover { transform: scale(1.1); }

        /* --- SETTINGS TOGGLES --- */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .toggle-switch {
            width: 50px; height: 26px;
            background: #ddd;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px; left: 3px;
            width: 20px; height: 20px;
            background: white;
            transition: 0.3s;
        }

        .toggle-switch.on { background: var(--fg); }
        .toggle-switch.on::after { left: 27px; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 1s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <div id="loader-screen">
        <div class="spiral-grid" id="grid-container"></div>
        <div class="loading-text">INITIALIZING SYSTEMS...</div>
    </div>

    <div id="app-container" class="hidden">
        
        <aside>
            <div>
                <h1>Maze<br>Duel.</h1>
                <p>P2P Navigation System</p>
                <div id="timer-display" class="hidden">00:00.00</div>
            </div>

            <div id="login-panel">
                <p style="margin-bottom:5px; font-weight:600; font-size:0.7rem;">CONNECTION TYPE</p>
                <button onclick="openModal('host-modal')" style="width:100%; margin-bottom:10px;">Host Game</button>
                <button onclick="openModal('join-modal')" class="secondary" style="width:100%;">Join Game</button>
            </div>

            <div id="game-status" class="hidden">
                <div style="margin-bottom:20px; border-left: 4px solid var(--p1); padding-left:10px;">
                    <small>YOU</small><br>
                    <strong>PLAYER 1</strong>
                </div>
                <div style="margin-bottom:20px; border-left: 4px solid var(--p2); padding-left:10px;">
                    <small>OPPONENT</small><br>
                    <strong>PLAYER 2</strong>
                </div>
                <div id="turn-indicator" style="font-weight:900; color: #aaa;">RACING...</div>
            </div>

            <div class="menu-items">
                <button class="secondary" onclick="openModal('settings-modal')">System Settings</button>
                <button class="secondary" onclick="openModal('help-modal')">Manual</button>
            </div>
        </aside>

        <main>
            <div id="empty-state">
                <h2 style="color:#ddd;">WAITING FOR INPUT</h2>
            </div>
            <canvas id="gameCanvas" class="hidden"></canvas>
        </main>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="closeAllModals()">×</button>
            </div>
            <div class="setting-row"><span>Invert Colors</span><div class="toggle-switch" onclick="toggleSetting(this)"></div></div>
            <div class="setting-row"><span>Show Grid Lines</span><div class="toggle-switch on" onclick="toggleSetting(this)"></div></div>
            <div class="setting-row"><span>High Contrast Mode</span><div class="toggle-switch" onclick="toggleSetting(this)"></div></div>
            <div class="setting-row"><span>Disable Animations</span><div class="toggle-switch" onclick="toggleSetting(this)"></div></div>
            <div class="setting-row"><span>Debug Telemetry</span><div class="toggle-switch on" onclick="toggleSetting(this)"></div></div>
            <div style="margin-top:20px; text-align:right;"><button onclick="closeAllModals()">Save Changes</button></div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manual</h2>
                <button class="close-btn" onclick="closeAllModals()">×</button>
            </div>
            <p><strong>OBJECTIVE:</strong> Navigate to the center of the grid.</p>
            <p><strong>CONTROLS:</strong> Use [ARROW KEYS] to move.</p>
            <p><strong>TIMER:</strong> Race against the clock and opponent.</p>
            <div style="margin-top:20px; text-align:right;"><button onclick="closeAllModals()">Close</button></div>
        </div>
    </div>

    <div id="host-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Host Session</h2>
                <button class="close-btn" onclick="closeAllModals()">×</button>
            </div>
            <p>Send this ID to your opponent:</p>
            <input type="text" id="my-id-display" readonly value="Generating..." style="background:#f4f4f4; color:#000; font-family:'Courier New'; font-weight:bold;">
            <p id="host-status">Waiting for peer...</p>
        </div>
    </div>

    <div id="join-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Join Session</h2>
                <button class="close-btn" onclick="closeAllModals()">×</button>
            </div>
            <p>Enter Host ID:</p>
            <input type="text" id="remote-id-input" placeholder="e.g. 5d3a-2f...">
            <button onclick="connectToHost()" style="width:100%">Connect</button>
        </div>
    </div>

<script>
    /* --- 1. DYNAMIC LOADING ANIMATION (6 Seconds, 3 Patterns) --- */
    const gridContainer = document.getElementById('grid-container');
    const blocks = [];

    // Create 100 blocks
    for(let i=0; i<100; i++) {
        let div = document.createElement('div');
        div.classList.add('block', 'animating');
        gridContainer.appendChild(div);
        blocks.push(div);
    }

    function applyPattern(type) {
        blocks.forEach((block, i) => {
            block.style.animation = 'none';
            block.offsetHeight; 
            block.style.animation = null; 
            const row = Math.floor(i / 10);
            const col = i % 10;
            let delay = 0;
            if (type === 'spiral') {
                const dist = Math.sqrt(Math.pow(row-4.5, 2) + Math.pow(col-4.5, 2));
                delay = dist * 0.1;
            } else if (type === 'waterfall') {
                delay = (row + col) * 0.1;
            } else if (type === 'chaos') {
                delay = Math.random() * 1.5;
            }
            block.style.animationDelay = `${delay}s`;
        });
    }

    let patternIndex = 0;
    const patterns = ['spiral', 'waterfall', 'chaos'];
    applyPattern(patterns[0]);

    const animInterval = setInterval(() => {
        patternIndex = (patternIndex + 1) % patterns.length;
        applyPattern(patterns[patternIndex]);
    }, 2000);

    setTimeout(() => {
        clearInterval(animInterval);
        document.getElementById('loader-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loader-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('fade-in');
            document.getElementById('app-container').style.display = 'grid'; 
        }, 1000);
    }, 6000); 

    /* --- 2. UI LOGIC --- */
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active')); }
    function toggleSetting(el) { el.classList.toggle('on'); }

    /* --- 3. TIMER LOGIC --- */
    let startTime = 0;
    let timerInterval = null;
    let myFinished = false;
    let opFinished = false;

    function startTimer() {
        startTime = Date.now();
        document.getElementById('timer-display').classList.remove('hidden');
        timerInterval = setInterval(() => {
            if(!myFinished) {
                const now = Date.now();
                const diff = now - startTime;
                const min = Math.floor(diff / 60000);
                const sec = Math.floor((diff % 60000) / 1000);
                const ms = Math.floor((diff % 1000) / 10);
                document.getElementById('timer-display').innerText = 
                    `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`;
            }
        }, 50);
    }

    function formatTime(msTime) {
         const diff = msTime;
         const min = Math.floor(diff / 60000);
         const sec = Math.floor((diff % 60000) / 1000);
         const ms = Math.floor((diff % 1000) / 10);
         return `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`;
    }

    /* --- 4. PEERJS & GAME LOGIC --- */
    const peer = new Peer();
    let conn = null;
    let myId = null;
    let isHost = false;

    const COLS = 31;
    const ROWS = 31;
    const CELL = 15;
    let maze = [];
    let p1 = {x:1, y:1, color:'var(--p1)'};
    let p2 = {x:COLS-2, y:ROWS-2, color:'var(--p2)'};
    let goal = {x: Math.floor(COLS/2), y: Math.floor(ROWS/2)};
    let gameRunning = false;

    peer.on('open', (id) => {
        myId = id;
        document.getElementById('my-id-display').value = id;
    });

    // --- HOST LOGIC ---
    peer.on('connection', (c) => {
        isHost = true;
        conn = c;
        conn.on('open', () => {
            closeAllModals();
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('game-status').classList.remove('hidden');
            generateMaze();
            conn.send({ type: 'INIT', maze: maze, sx: COLS-2, sy: ROWS-2 });
            startGame(true);
        });
        conn.on('data', (d) => processData(d));
    });

    // --- JOIN LOGIC ---
    function connectToHost() {
        isHost = false;
        let id = document.getElementById('remote-id-input').value;
        if(!id) return;
        conn = peer.connect(id);
        conn.on('open', () => {
            closeAllModals();
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('game-status').classList.remove('hidden');
        });
        conn.on('data', (d) => processData(d));
    }

    // Shared Data Handler
    function processData(data) {
        if(data.type === 'INIT') {
            maze = data.maze;
            p1.x = 1; p1.y = 1;
            p2.x = data.sx; p2.y = data.sy;
            startGame(false);
        } else if (data.type === 'MOVE') {
            if(isHost) { p2.x = data.x; p2.y = data.y; }
            else { p1.x = data.x; p1.y = data.y; }
            draw();
        } else if (data.type === 'WIN') {
            // OPPONENT FINISHED
            opFinished = true;
            // Don't stop gameRunning, allow self to continue
            const timeStr = formatTime(data.time);
            alert(`OPPONENT FINISHED: ${timeStr}`);
            // Update UI status
            const statusEl = document.getElementById('turn-indicator');
            statusEl.innerText = `OPPONENT FINISHED [${timeStr}]. KEEP GOING!`;
            statusEl.style.color = "var(--p2)";
        }
    }

    /* --- GAME ENGINE --- */
    function startGame(amIHost) {
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('gameCanvas').classList.remove('hidden');
        
        const canvas = document.getElementById('gameCanvas');
        canvas.width = COLS * CELL;
        canvas.height = ROWS * CELL;
        
        gameRunning = true;
        myFinished = false;
        opFinished = false;
        startTimer();
        draw();
    }

    document.addEventListener('keydown', (e) => {
        if(!gameRunning || myFinished) return; // Only block if I am finished
        
        let me = isHost ? p1 : p2;
        let tx = me.x; 
        let ty = me.y;

        if(e.key === 'ArrowUp') ty--;
        if(e.key === 'ArrowDown') ty++;
        if(e.key === 'ArrowLeft') tx--;
        if(e.key === 'ArrowRight') tx++;

        if(maze[ty][tx] === 0) {
            me.x = tx; me.y = ty;
            conn.send({ type: 'MOVE', x: tx, y: ty });
            draw();
            
            if(me.x === goal.x && me.y === goal.y) {
                myFinished = true;
                const endTime = Date.now() - startTime;
                conn.send({ type: 'WIN', time: endTime });
                alert(`MISSION ACCOMPLISHED: ${formatTime(endTime)}`);
                // Stop timer visually
                clearInterval(timerInterval);
                document.getElementById('timer-display').innerText = formatTime(endTime);
                document.getElementById('turn-indicator').innerText = "FINISHED.";
            }
        }
    });

    function draw() {
        const ctx = document.getElementById('gameCanvas').getContext('2d');
        ctx.fillStyle = "white";
        ctx.fillRect(0,0, 1000, 1000);

        // Walls
        for(let y=0; y<ROWS; y++) {
            for(let x=0; x<COLS; x++) {
                if(maze[y][x] === 1) {
                    ctx.fillStyle = "black";
                    ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
                }
            }
        }

        // Goal
        ctx.fillStyle = "#ccc";
        ctx.fillRect(goal.x*CELL, goal.y*CELL, CELL, CELL);

        // Players
        ctx.fillStyle = "#0000ff"; // P1 Blue
        ctx.fillRect(p1.x*CELL, p1.y*CELL, CELL, CELL);
        
        ctx.fillStyle = "#ff0000"; // P2 Red
        ctx.fillRect(p2.x*CELL, p2.y*CELL, CELL, CELL);
    }

    // Maze Gen (Recursive Backtracker)
    function generateMaze() {
        maze = Array(ROWS).fill().map(() => Array(COLS).fill(1));
        let stack = [{x:1, y:1}];
        maze[1][1] = 0;

        while(stack.length) {
            let cur = stack[stack.length-1];
            let dirs = [{x:0,y:-2}, {x:0,y:2}, {x:-2,y:0}, {x:2,y:0}].sort(()=>Math.random()-0.5);
            let found = false;
            for(let d of dirs) {
                let nx = cur.x + d.x, ny = cur.y + d.y;
                if(nx>0 && nx<COLS-1 && ny>0 && ny<ROWS-1 && maze[ny][nx]===1) {
                    maze[ny][nx] = 0;
                    maze[cur.y+d.y/2][cur.x+d.x/2] = 0;
                    stack.push({x:nx, y:ny});
                    found = true;
                    break;
                }
            }
            if(!found) stack.pop();
        }
        maze[goal.y][goal.x] = 0;
        maze[ROWS-2][COLS-2] = 0;
    }
</script>
</body>
</html>
